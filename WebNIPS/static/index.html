<!--
// Muaz Khan     - www.MuazKhan.com
// MIT License   - www.WebRTC-Experiment.com/licence
// Experiments   - github.com/muaz-khan/WebRTC-Experiment
-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>NIPS Demonstrator</title>
    <script>
    if (location.href.indexOf('file:') == 0) {
        document.write('<h1 style="color:red;">Please load this HTML file on HTTP or HTTPS.</h1>');
    }
    </script>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="author" type="text/html" href="https://plus.google.com/+MuazKhan">
    <meta name="author" content="Muaz Khan">
    <script src="https://www.webrtc-experiment.com/RecordRTC.js">
    </script>
    <style>

    html,body {
        padding:0;
        margin:0;
        height:100%;
        min-height:100%;
        background-color: white;
    }
    
    hr {
        border: 0;
        border-top: 1px solid rgb(15, 158, 238);
    }
    
    a {
        color: #2844FA;
        text-decoration: none;
    }
    
    a:hover,
    a:focus {
        color: #1B29A4;
    }
    
    a:active {
        color: #000;
    }
    
    audio,
    video {
        border: 1px solid rgb(15, 158, 238);
        width: 90%;
        margin-top: 3%;
        margin-bottom: 1%;
        display: block;
    }
    
    button[disabled],
    input[disabled] {
        background: rgba(216, 205, 205, 0.2);
        border: 1px solid rgb(233, 224, 224);
    }

    /*.traitBar {
        width: 60%;
        border: 1px solid black;
        position: relative;
        margin-left: 10%;
        margin-top: 5px;
        height: 20px;
    }*/

    .traitBar {
        width: 60%;
        border: 1px solid black;
        position: relative;
        margin-left: 10%;
        margin-top: 0;
        margin-bottom: 0;
        height: 20px;
    }

    .jobTraitBar {
        width: 60%;
        border: 1px solid black;
        position: relative;
        margin-left: 10%;
        height: 15px;
        margin-top: 0;
        margin-bottom: 0;
        display: none;
    }

    .trait {
        position: absolute;
        left: 30%;
    }

    .traitFill {
        height: 20px;
    }

    .jobTraitFill {
        height: 15px;
        background-color: green;
    }

    </style>
</head>

<body>


    <div style="background-color:ghostwhite; width:50%; height:100%; float:left">
        <img src="avatar.png" alt="Tell me something about yourself" width="80%">
        <div id="results" style="visibility: hidden;">
            <p style="font-size: 20px; margin-left: 5%"><b>Your results:</b></p>
            <div class="traitBar">
                <span id="traitC" class="trait"><b>70% Conscientiusness</b></span>
                <div id="traitFillC" class="traitFill" style="background-color: yellow; width: 70%;"></div>
            </div> 
            <div class="jobTraitBar"> 
                <div class="jobTraitFill" style="width: 23%;"></div>
            </div> <br/>
            <div class="traitBar">
                <span id="traitA" class="trait"><b>40% Agreeableness</b></span>
                <div id="traitFillA" class="traitFill" style="background-color: cornflowerblue; width: 40%;"></div>
            </div> 
            <div class="jobTraitBar">
                <div class="jobTraitFill" style="width: 58%;"></div>
            </div> <br/>
            <div class="traitBar">
                <span id="traitN" class="trait"><b>60% Neuroticism</b></span>
                <div id="traitFillN" class="traitFill" style="background-color: indianred; width: 60%;"></div>
            </div> 
            <div class="jobTraitBar">
                <div class="jobTraitFill" style="width: 94%;"></div>
            </div> <br/>
            <div class="traitBar">
                <span id="traitO" class="trait"><b>30% Openness</b></span>
                <div id="traitFillO" class="traitFill" style="background-color: purple; width: 30%;"></div>
            </div> 
            <div class="jobTraitBar">
                <div class="jobTraitFill" style="width: 36%;"></div>
            </div> <br/>
            <div class="traitBar">
                <span id="traitE" class="trait"><b>90% Extraversion</b></span>
                <div id="traitFillE" class="traitFill" style="background-color: darkorange; width: 90%;"></div>
            </div> 
            <div class="jobTraitBar">
                <div class="jobTraitFill" style="width: 11%;"></div>
            </div> <br/>
        </div>
    </div>

    <div style="background-color:ghostwhite; width:50%; height:100%; float:right">
        <div id="videoDiv">
            <video></video>

            <!--<div style="margin: 0 auto; width:250px">
                <label id="percentage">0%</label>
                <progress id="progress-bar" value="0"></progress>
                <br />
            </div> -->

            <div style="margin: 0 auto; width:250px">
                <button id="btn-start-recording">Start Recording</button>
                <!-- <button id="btn-stop-recording" disabled="">Stop Recording</button> -->
            </div>
        </div>

        <div id="jobs" style="visibility: hidden;">
            <p style="font-size: 20px; margin-left: 5%"><b>Job adjustment:</b></p>
            <div class="traitBar" id="manager">
                <span class="trait"><b>70% Manager</b></span>
                <div class="traitFill" style="background-color: lightgreen; width: 70%;"></div>
            </div> <br/>
            <div class="traitBar">
                <span class="trait"><b>40% Entrepreneur</b></span>
                <div class="traitFill" style="background-color: orange; width: 40%;"></div>
            </div> <br/>
            <div class="traitBar">
                <span class="trait"><b>60% Social</b></span>
                <div class="traitFill" style="background-color: yellow; width: 60%;"></div>
            </div> <br/>
            <div class="traitBar">
                <span class="trait"><b>30% Public Sector</b></span>
                <div class="traitFill" style="background-color: red; width: 30%;"></div>
            </div> <br/>
            <div class="traitBar">
                <span class="trait"><b>90% Scientist</b></span>
                <div class="traitFill" style="background-color: green; width: 90%;"></div>
            </div> <br/>
        </div>
        <div id="sentences" style="visibility:hidden;">
            <p>Your aparent <b>agreeableness</b> trait is <b>low</b> for a human resources job.</p>
            <p>Others perceive you as being <b>more agresive</b> anb <b>less cooperative</b>.</p>
            <p>Try to talk in a <b>more easy going</b> manner</p>
        </div>
    </div>

    

    <script>
    // fetching DOM references
    var btnStartRecording = document.querySelector('#btn-start-recording');
    btnStartRecording.disabled = false;
    //var btnStopRecording = document.querySelector('#btn-stop-recording');
    var videoElement = document.querySelector('video');
    var videoDiv = document.querySelector('#videoDiv');
    var jobs = document.querySelector('#jobs');
    var sentences = document.querySelector('#sentences');
    var results = document.querySelector('#results');
    var progressBar = document.querySelector('#progress-bar');
    var percentage = document.querySelector('#percentage');
    var traitC = document.querySelector('#traitC');
    var traitA = document.querySelector('#traitA');
    var traitN = document.querySelector('#traitN');
    var traitO = document.querySelector('#traitO');
    var traitE = document.querySelector('#traitE');
    var traitFillC = document.querySelector('#traitFillC');
    var traitFillA = document.querySelector('#traitFillA');
    var traitFillN = document.querySelector('#traitFillN');
    var traitFillO = document.querySelector('#traitFillO');
    var traitFillE = document.querySelector('#traitFillE');
    var manager = document.querySelector('#manager');
    </script>

    // <script>
    //     var text = "the code to run";
    //     var bad = "EVAL "  + JSON.stringify(text) + " 0\r\n";
    //     var x = new XMLHttpRequest();
    //     x.open("POST", "http://localhost:5000/test");
    //     x.send(bad);

    //     function readBody(xhr) {
    //         var data;
    //         if (!xhr.responseType || xhr.responseType === "text") {
    //             data = xhr.responseText;
    //         } else if (xhr.responseType === "document") {
    //             data = xhr.responseXML;
    //         } else {
    //             data = xhr.response;
    //         }
    //         return data;
    //     };

    //     traitC.innerHTML = readBody(x);
        

    // </script>

    <script>
    // global variables
    var currentBrowser = !!navigator.mozGetUserMedia ? 'gecko' : 'chromium';

    var fileName;
    var audioRecorder;
    var videoRecorder;

    // Firefox can record both audio/video in single webm container
    // Don't need to create multiple instances of the RecordRTC for Firefox
    // You can even use below property to force recording only audio blob on chrome
    // var isRecordOnlyAudio = true;
    var isRecordOnlyAudio = !!navigator.mozGetUserMedia;

    // if recording only audio, we should replace "HTMLVideoElement" with "HTMLAudioElement"
    if (isRecordOnlyAudio && currentBrowser == 'chromium') {
        var parentNode = videoElement.parentNode;
        parentNode.removeChild(videoElement);

        videoElement = document.createElement('audio');
        videoElement.style.padding = '.4em';
        videoElement.controls = true;
        parentNode.appendChild(videoElement);
    }
    </script>

    <script>
    // reusable helpers

    // this function submits both audio/video or single recorded blob to nodejs server
    function postFiles(audio, video) {
        // getting unique identifier for the file name
        fileName = generateRandomString();

        // this object is used to allow submitting multiple recorded blobs
        var files = {};

        // recorded audio blob
        files.audio = {
            name: fileName + '.' + audio.blob.type.split('/')[1],
            type: audio.blob.type,
            contents: audio.dataURL
        };

        if (video) {
            files.video = {
                name: fileName + '.' + video.blob.type.split('/')[1],
                type: video.blob.type,
                contents: video.dataURL
            };
        }

        files.uploadOnlyAudio = !video;

        videoElement.src = '';
        videoElement.poster = '/ajax-loader.gif';

        xhr('/upload', JSON.stringify(files), function(_fileName) {
            var href = location.href.substr(0, location.href.lastIndexOf('/') + 1);
            videoElement.src = href + 'uploads/' + _fileName;
            videoElement.play();
            videoElement.muted = false;
            videoElement.controls = true;
        });

        if (mediaStream) mediaStream.stop();
        
    }

    function showResuts() {
        valueC = 0.34;
        valueA = 0.67;
        valueN = 0.45;
        valueO = 0.92;
        valueE = 0.23;
        valueC = valueC*100;
        valueA = valueA*100;
        valueN = valueN*100;
        valueO = valueO*100;
        valueE = valueE*100;
        bold = "<b>";
        pC = valueC.toString();
        percent = "%";
        percentC = pC.concat(percent);
        C = " Conscientiousness</b>"
        newC = bold.concat(percentC, C);
        traitC.innerHTML =  newC;
        traitFillC.style.width = percentC;
        results.style.visibility = "visible";
        videoDiv.style.display = "none";
        jobs.style.visibility = "visible";
        
        
    }

    // XHR2/FormData
    function xhr(url, data, callback) {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (request.readyState == 4 && request.status == 200) {
                callback(request.responseText);
            }
        };

        request.upload.onprogress = function(event) {
            progressBar.max = event.total;
            progressBar.value = event.loaded;
            progressBar.innerHTML = 'Upload Progress ' + Math.round(event.loaded / event.total * 100) + "%";
        };

        request.upload.onload = function() {
            percentage.style.display = 'none';
            progressBar.style.display = 'none';
        };
        request.open('POST', url);
        request.send(data);
    }

    // generating random string (for the name of the file)
    function generateRandomString() {
        if (window.crypto) {
            var a = window.crypto.getRandomValues(new Uint32Array(3)),
                token = '';
            for (var i = 0, l = a.length; i < l; i++) token += a[i].toString(36);
            return token;
        } else {
            return (Math.random() * new Date().getTime()).toString(36).replace(/\./g, '');
        }
    }

    // when btnStopRecording is clicked
    function onStopRecording() {
        audioRecorder.getDataURL(function(audioDataURL) {
            var audio = {
                blob: audioRecorder.getBlob(),
                dataURL: audioDataURL
            };

            // if record both wav and webm
            if (!isRecordOnlyAudio) {
                videoRecorder.getDataURL(function(videoDataURL) {
                    var video = {
                        blob: videoRecorder.getBlob(),
                        dataURL: videoDataURL
                    };

                    postFiles(audio, video);
                });
            }

            // if record only audio (either wav or ogg)
            if (isRecordOnlyAudio) postFiles(audio);
        });
        
    }
    </script>

    <script>
    var mediaStream = null;
    // reusable getUserMedia
    function captureUserMedia(success_callback) {
        var session = {
            audio: true,
            video: true
        };

        navigator.getUserMedia(session, success_callback, function(error) {
            alert(JSON.stringify(error));
        });
    }
    </script>

    <script>
    // UI events handling
    btnStartRecording.onclick = function() {
        btnStartRecording.disabled = true;

        captureUserMedia(function(stream) {
            mediaStream = stream;

            videoElement.src = window.URL.createObjectURL(stream);
            videoElement.play();
            videoElement.muted = true;
            videoElement.controls = false;

            // it is second parameter of the RecordRTC
            var audioConfig = {};
            if (!isRecordOnlyAudio) {
                audioConfig.onAudioProcessStarted = function() {
                    // invoke video recorder in this callback
                    // to get maximum sync
                    videoRecorder.startRecording();
                };
            }

            audioRecorder = RecordRTC(stream, audioConfig);

            if (!isRecordOnlyAudio) {
                // it is second parameter of the RecordRTC
                var videoConfig = {
                    type: 'video'
                };
                videoRecorder = RecordRTC(stream, videoConfig);
            }

            audioRecorder.startRecording();

            setTimeout(stopRecording, 3000);
        });
    };

    manager.onclick = function() {
        var bars =     document.getElementsByClassName('jobTraitBar');
        for(i=0; i<bars.length; i++) {
            bars[i].style.display =  "block";
        }
        sentences.style.visibility = "visible";
    };


    function stopRecording() {
        btnStartRecording.disabled = false;

        if (isRecordOnlyAudio) {
            audioRecorder.stopRecording(onStopRecording);
        }

        if (!isRecordOnlyAudio) {
            audioRecorder.stopRecording(function() {
                videoRecorder.stopRecording(function() {
                    onStopRecording();
                });
            });
        }
        showResuts();
    };
    </script>

    <script>
    window.onbeforeunload = function() {
        startRecording.disabled = false;
    };
    </script>

</body>

</html>